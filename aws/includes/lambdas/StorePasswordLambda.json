{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "LambdaDeployRole": {
            "Type": "String"
        }
    },
    "Resources": {
        "StorePasswordLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Encrypts given string and saves chipper to bucket",
                "Code": {
                    "ZipFile": {
                        "Fn::Join": [
                            "\n",
                            [
                                "import uuid",
                                "import boto3",
                                "import cfnresponse",
                                "",
                                "def createFile(bucket, file, body):",
                                "    s3Client = boto3.client('s3')",
                                "    return s3Client.put_object(",
                                "        Bucket = bucket,",
                                "        Key = file,",
                                "        ServerSideEncryption = 'AES256',",
                                "        Body = body",
                                "    )",
                                "",
                                "def deleteFile(bucket, file):",
                                "    s3Client = boto3.client('s3')",
                                "    return s3Client.delete_object(",
                                "        Bucket = bucket,",
                                "        Key = file",
                                "    )",
                                "",
                                "def lambda_handler(event, context):",
                                "",
                                "    physicalResourceId = str(uuid.uuid4())",
                                "    if 'PhysicalResourceId' in event:",
                                "        physicalResourceId = event['PhysicalResourceId']",
                                "",
                                "    for key in ['PlainText', 'BucketId']:",
                                "        if key not in event['ResourceProperties'] or not event['ResourceProperties'][key]:",
                                "            print 'The properties PlainText and BucketId must not be empty'",
                                "            return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)",
                                "",
                                "    try:",
                                "        if event['RequestType'] == 'Delete':",
                                "            deleteFile(event['ResourceProperties']['BucketId'], physicalResourceId)",
                                "            print 'The secret file deleted'",
                                "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                                "",
                                "        if event['RequestType'] == 'Create':",
                                "            createFile(event['ResourceProperties']['BucketId'], physicalResourceId, event['ResourceProperties']['PlainText'])",
                                "            print 'The secret file created'",
                                "            response = { 'FileId': physicalResourceId }",
                                "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, response, physicalResourceId)",
                                "",
                                "    except Exception as E:",
                                "        print E",
                                "        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                            ]
                        ]
                    }
                },
                "Runtime": "python2.7",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Ref": "LambdaDeployRole"
                }
            }
        }
    },
    "Outputs": {
        "Arn": {
            "Value": { "Fn::GetAtt": ["StorePasswordLambda", "Arn"] }
        }
    }
}