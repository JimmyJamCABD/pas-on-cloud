{
   "$schema":"http://schema-management-azure-com.o365.apps.cyberark.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "License Agreement":{
         "defaultValue":"Decline",
         "allowedValues":[
            "Accept",
            "Decline"
         ],
         "maxLength":6,
         "type":"String",
         "metadata":{
            "description":"I have read and agree to the Terms and Conditions."
         }
      },
      "Vault Storage Account Name":{
         "type":"String",
         "metadata":{
            "description":"Enter the name of the storage account that contains the license and public key."
         }
      },
      "Storage Container Name":{
         "type":"String",
         "metadata":{
            "description":"Enter the name of the container in the Vault storage account that contains the license and public key."
         }
      },
      "Vault Storage Account Access Key":{
         "type":"SecureString",
         "metadata":{
            "description":"Enter the access key of the storage account that contains the license and public key."
         }
      },
      "License File":{
         "defaultValue":"license.xml",
         "type":"String",
         "metadata":{
            "description":"Enter the name of the license file in the container. Note: This field is case sensitive"
         }
      },
      "Recovery Public Key":{
         "defaultValue":"recpub.key",
         "type":"String",
         "metadata":{
            "description":"Enter the name of the public key file in the container. Note: This field is case sensitive"
         }
      },
      "Key Vault Name":{
         "type":"String",
         "defaultValue":"null",
         "minLength":3,
         "maxLength":24,
         "metadata":{
            "description":"Enter the name of the Key Vault , verify it does not already exist"
         }
      },
      "Primary Vault Master Password":{
         "type":"SecureString",
         "metadata":{
            "description":"Enter a password for the Primary Vault Master user."
         }
      },
      "Primary Vault Administrator Password":{
         "type":"SecureString",
         "metadata":{
            "description":"Enter a password for the Primary Vault Administrator user."
         }
      },
      "Primary Vault VM Host Name":{
         "type":"String",
         "metadata":{
            "description":"Enter the host name for the Primary Vault VM."
         }
      },
      "Primary Vault VM Size":{
         "defaultValue":"Standard_D2s_v3",
         "type":"String",
         "metadata":{
            "description":"Enter the desired VM Size"
         }
      },
      "Primary Vault VM Admin User":{
         "type":"String",
         "metadata":{
            "description":"Enter Primary Vault VM Administrator user."
         }
      },
      "Primary Vault VM Admin Password":{
         "type":"SecureString",
         "metadata":{
            "description":"Enter Primary Vault VM Administrator password."
         }
      },
      "ImageID":{
         "type":"String",
         "metadata":{
            "description":"Enter Vault Image ID."
         }
      },
      "Availability Zone":{
         "type":"string",
         "allowedValues": [
             "1",
             "2",
             "3"
         ],
         "defaultValue": "1",
         "metadata":{
            "description":"Choose the availability zone for the Primary Vault VM"
         }
      },
      "Primary Vault VNet Name":{
         "type":"String",
         "defaultValue": "PAS-VNet",
         "metadata":{
            "description":"Enter the VNet for the Primary Vault VM"
         }
      },
	"Primary Vault Subnet Name": {
	    "type": "String",
	    "defaultValue": "Vault-Subnet",
	    "metadata": {
	        "description": "Enter the VNet for the Primary Vault VM"
	    }
	},
      "DR Vault VNet Name":{
         "type":"String",
         "defaultValue": "PAS-VNet",
         "metadata":{
            "description":"Enter the VNet for the DR Vault VM"
         }
        },
        "DR Vault Subnet Name": {
            "type": "String",
            "defaultValue": "Vault-Subnet",
            "metadata": {
                "description": "Enter the VNet for the DR Vault VM"
            }
        }
   },
   "variables":{
      "vnetIdVault":"[resourceId('Microsoft.Network/virtualNetworks', parameters('Primary Vault VNet Name'))]",
      "vnetIdVaultDR":"[resourceId('Microsoft.Network/virtualNetworks', parameters('DR Vault VNet Name'))]",
      "subnetRefVault":"[concat(variables('vnetIdVault'), '/subnets/',parameters('Primary Vault Subnet Name'))]",
      "subnetRefVaultDR":"[concat(variables('vnetIdVaultDR'), '/subnets/',parameters('DR Vault Subnet Name'))]",
      "networkInterfaceName":"[toLower(concat(parameters('Primary Vault VM Host Name'), '-', uniqueString(resourceGroup().id)))]",
      "publicIpAddressName":"[toLower(concat(parameters('Primary Vault VM Host Name'), '-', uniqueString(resourceGroup().id)))]",
      "keyVaultName":"[parameters('Key Vault Name')]"
   },
   "resources":[
      {
         "type":"Microsoft.Resources/deployments",
         "name": "pid-920ca5c9-254e-5fa2-87f3-eba1b62dc92d",
         "apiVersion": "2018-02-01",
         "properties":{
            "mode":"incremental",
            "template":{
               "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
               "contentVersion":"1.0.0.0",
               "resources": []
            }
         }
      },
      {
         "condition": "[not(equals(variables('keyVaultName'),'null'))]",
         "type":"Microsoft.KeyVault/vaults",
         "name":"[variables('keyVaultName')]",
         "apiVersion":"2015-06-01",
         "location":"[resourceGroup().location]",
         "properties":{
            "tenantId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name')), '2017-03-30', 'Full').identity.tenantId]",
            "accessPolicies":[
               {
                  "tenantId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name')), '2017-03-30', 'Full').identity.tenantId]",
                  "objectId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name')), '2017-03-30', 'Full').identity.principalId]",
                  "permissions":{
                     "keys":[
                        "create",
                        "wrapKey",
                        "unwrapKey"
                     ]
                  }
               }
            ],
            "sku":{
               "family":"A",
               "name":"Premium"
            },
            "networkAcls":{
               "bypass":"None",
               "defaultAction":"Deny",
               "virtualNetworkRules":[
                  {
                     "id":"[variables('subnetRefVault')]"
                  },
                  {
                     "id":"[if(not(empty(variables('subnetRefVaultDR'))),variables('subnetRefVaultDR'),variables('subnetRefVault'))]"
                  }
               ]
            }
         },
         "dependsOn":[
            "[concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name'))]"
         ]
      },
      {
         "type":"Microsoft.Compute/virtualMachines/extensions",
         "name":"[concat(parameters('Primary Vault VM Host Name'),'/ManagedIdentityExtensionForWindows')]",
         "apiVersion":"2018-06-01",
         "location":"[resourceGroup().location]",
         "properties":{
            "publisher":"Microsoft.ManagedIdentity",
            "type":"ManagedIdentityExtensionForWindows",
            "typeHandlerVersion":"1.0",
            "autoUpgradeMinorVersion":true,
            "settings":{
               "port":50342
            }
         },
         "dependsOn":[
            "[concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name'))]"
         ]
      },
      {
         "type":"Microsoft.Compute/virtualMachines",
         "name":"[parameters('Primary Vault VM Host Name')]",
         "apiVersion":"2019-07-01",
         "location":"[resourceGroup().location]",
         "zones": [
               "[parameters('Availability Zone')]"
         ],
         "identity":{
            "type":"SystemAssigned"
         },
         "properties":{
            "osProfile":{
               "computerName":"[parameters('Primary Vault VM Host Name')]",
               "adminUsername":"[parameters('Primary Vault VM Admin User')]",
               "adminPassword":"[parameters('Primary Vault VM Admin Password')]",
               "windowsConfiguration":{
                  "provisionVmAgent":"true"
               }
            },
            "hardwareProfile":{
               "vmSize":"[parameters('Primary Vault VM Size')]"
            },
            "storageProfile":{
               "imageReference":{
                  "id":"[parameters('ImageID')]"
               },
               "osDisk":{
                  "createOption":"FromImage",
                  "managedDisk":{
                     "storageAccountType":"Premium_LRS"
                  }
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                  }
               ]
            }
         },
         "dependsOn":[
            "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
         ]
      },
      {
         "type":"Microsoft.Compute/virtualMachines/extensions",
         "name":"[concat(parameters('Primary Vault VM Host Name'),'/', 'customscript')]",
         "apiVersion":"2015-06-15",
         "location":"[resourceGroup().location]",
         "tags":{
            "displayName":"activate-vault"
         },
         "properties":{
            "publisher":"Microsoft.Compute",
            "type":"CustomScriptExtension",
            "typeHandlerVersion":"1.9",
            "autoUpgradeMinorVersion":true,

            "protectedSettings":{
                    "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file ', 'C:\\CyberArk\\HardeningActivation.ps1', ' -AdminPass ', parameters('Primary Vault VM Admin Password'), ' -MasterPass ', parameters('Primary Vault Master Password'), ' -PrimaryOrDR Primary -PrimaryVaultIP 1.1.1.1 -DRPassword ', parameters('Primary Vault VM Admin Password'), ' -LicenseFileName ', parameters('License File'), ' -RecPubFileName ', parameters('Recovery Public Key'), ' -StorageName ', parameters('Vault Storage Account Name'), ' -ContainerName ', parameters('Storage Container Name'), ' -StorageAccountKey ', parameters ('Vault Storage Account Access Key'), ' -VKMName ', parameters ('Key Vault Name'))]"
            }
         },
         "dependsOn":[
            "[concat('Microsoft.Compute/virtualMachines/', parameters('Primary Vault VM Host Name'), '/extensions/ManagedIdentityExtensionForWindows')]",
            "[concat('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]"
         ]
      },
      {
         "type":"Microsoft.Network/networkInterfaces",
         "name":"[variables('networkInterfaceName')]",
         "apiVersion":"2016-09-01",
         "location":"[resourceGroup().location]",
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig1",
                  "properties":{
                     "subnet":{
                        "id":"[variables('subnetRefVault')]"
                     },
                     "privateIPAllocationMethod":"Dynamic"
                  }
               }
            ]
         }
      }
   ],
   "outputs":{
      "adminUsername":{
         "type":"String",
         "value":"[parameters('Primary Vault VM Admin User')]"
      },
      "networkInterface":{
         "value":"[reference(resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName')),'2016-09-01')]",
         "type":"object"
      }
   }
}
